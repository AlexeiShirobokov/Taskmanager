{% extends 'base.html' %}
{% load custom_tags %}
{% block title %}–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏{% endblock %}

{% block content %}
  <h2 class="title is-4">{{ task.title }}</h2>

  <div class="box">
    <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ task.description }}</p>
    <p><strong>–°—Ä–æ–∫:</strong> {{ task.deadline|date:"d.m.Y H:i" }}</p>
    <p><strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> {{ task.responsible.get_full_name|default:task.responsible.username }}</p>
    <p><strong>–°–æ–∑–¥–∞–Ω–∞:</strong> {{ task.created_at|date:"d.m.Y H:i" }}</p>
    <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
      {% if task.is_completed %}
        <span class="tag is-success">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
      {% else %}
        <span class="tag is-warning">–í —Ä–∞–±–æ—Ç–µ</span>
      {% endif %}
    </p>

    {% if can_complete and not task.is_completed %}
      <form method="post" action="{% url 'complete_task' task.pk %}" class="mt-3">
        {% csrf_token %}
        <button class="button is-success is-small">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É</button>
      </form>
    {% endif %}

    {% if user == task.creator %}
      <a href="{% url 'task_create' %}?edit={{ task.pk }}" class="button is-warning is-small mt-2">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
    {% endif %}
  </div>

  <div class="box">
    <h3 class="title is-5">–§–∞–π–ª—ã</h3>

    <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
    {% if user in task.participants.all or user == task.creator or user == task.responsible %}
    <form method="post" enctype="multipart/form-data" action="{% url 'upload_files' task.pk %}">
      {% csrf_token %}
      <div class="field">
        <label class="label">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª—ã (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ):</label>
        <div class="control">
          <input type="file" name="files" multiple class="input">
        </div>
      </div>
      <button class="button is-link" type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </form>
    {% endif %}

    <!-- –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ -->
    <div class="mt-4">
      {% if task.files.all %}
        <ul>
          {% for file in task.files.all %}
            <li class="mb-2">
              <a href="{{ file.file.url }}" download class="is-link">
                üìé {{ file.filename }}
              </a>
              ({{ file.file.size|filesizeformat }})
              <small class="has-text-grey">–∑–∞–≥—Ä—É–∂–µ–Ω–æ {{ file.uploaded_at|date:"d.m.Y H:i" }}</small>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p><em>–ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</em></p>
      {% endif %}
    </div>
  </div>

  <div class="box">
    <h3 class="title is-5">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
    <ul>
      {% for participant in participants %}
        <li>{{ participant.user.get_full_name|default:participant.user.username }} ‚Äî {{ participant.get_role_display }}</li>
      {% endfor %}
    </ul>
  </div>

  <div class="box">
    <h3 class="title is-5">–°–æ–æ–±—â–µ–Ω–∏—è</h3>
    <div id="messages">
      {% for message in task_messages %}
        <article class="message is-small">
          <div class="message-header">
            <p>{{ message.sender.get_full_name|default:message.sender.username }} ‚Äî {{ message.timestamp|date:"d.m.Y H:i" }}</p>
          </div>
          <div class="message-body">
            {{ message.content|linebreaksbr }}
          </div>
        </article>
      {% empty %}
        <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
      {% endfor %}
    </div>

    <form method="post" action="{% url 'task_detail' task.pk %}" class="mt-4">
      {% csrf_token %}
      <div class="field">
        <div class="control">
          <textarea name="content" class="textarea" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required></textarea>
        </div>
      </div>
      <div class="control">
        <button class="button is-link is-small">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </form>
  </div>
{% endblock %}