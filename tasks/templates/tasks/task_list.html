{% extends 'base.html' %}
{% load custom_tags %}
{% block title %}–ú–æ–∏ –∑–∞–¥–∞—á–∏{% endblock %}
{% block content %}
  <h2 class="title is-4">–ú–æ–∏ –∑–∞–¥–∞—á–∏</h2>

  <form method="get" class="mb-4">
    <div class="columns is-multiline">
      <div class="column is-3">
        <input type="text" name="q" value="{{ query }}" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–µ –∏–ª–∏ –§–ò–û">
      </div>
      <div class="column is-2">
        <input type="date" name="date_from" value="{{ date_from }}" class="input" placeholder="–û—Ç">
      </div>
      <div class="column is-2">
        <input type="date" name="date_to" value="{{ date_to }}" class="input" placeholder="–î–æ">
      </div>
      <div class="column is-2">
        <button class="button is-info is-fullwidth" type="submit">–§–∏–ª—å—Ç—Ä</button>
      </div>
      <div class="column is-3">
        <a href="?{% if query %}q={{ query }}&{% endif %}{% if date_from %}date_from={{ date_from }}&{% endif %}{% if date_to %}date_to={{ date_to }}&{% endif %}export=1" class="button is-success is-fullwidth">–°–∫–∞—á–∞—Ç—å Excel</a>
      </div>
    </div>
  </form>

  <div class="tabs is-boxed">
    <ul>
      <li class="{% if active_tab == 'creator' %}is-active{% endif %}" onclick="showTab('creator')"><a>–°–æ–∑–¥–∞–Ω–Ω—ã–µ –º–Ω–æ–π</a></li>
      <li class="{% if active_tab == 'responsible' %}is-active{% endif %}" onclick="showTab('responsible')"><a>–ú–Ω–µ –ø–æ—Ä—É—á–µ–Ω—ã</a></li>
      <li class="{% if active_tab == 'participant' %}is-active{% endif %}" onclick="showTab('participant')"><a>–Ø —É—á–∞—Å—Ç–Ω–∏–∫</a></li>
      <li class="{% if active_tab == 'completed' %}is-active{% endif %}" onclick="showTab('completed')"><a>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</a></li>
    </ul>
  </div>

  {% for role, tasks in tasks_by_role.items %}
    <div class="task-tab" id="tab-{{ role }}" {% if role != active_tab %}style="display:none"{% endif %}>
      {% if tasks %}
      <table class="table is-striped is-fullwidth">
        <thead>
          <tr>
            <th>–¢–µ–º–∞</th>
            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th>–°—Ä–æ–∫</th>
            <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
            <th>–†–æ–ª—å</th>
            <th>–§–∞–π–ª—ã</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
        {% for task in tasks %}
          <tr>
            <td><a href="{% url 'task_detail' task.pk %}">{{ task.title }}</a></td>
            <td>{{ task.description|truncatewords:12 }}</td>
            <td>{{ task.deadline|date:"d.m.Y H:i" }}</td>
            <td>
              {% if task.responsible %}
                {{ task.responsible.get_full_name|default:task.responsible.username }}
              {% else %}<em>‚Äî</em>{% endif %}
            </td>
            <td>{{ roles_by_task|dict_get:task.id }}</td>
            <td>
              {% with total_files=task.files.count %}
                {% if total_files > 0 %}
                  <a href="{% url 'task_detail' task.pk %}#files">
                    üìé {{ total_files }} —Ñ–∞–π–ª(–æ–≤)
                  </a>
                {% else %}
                  <em>‚Äî</em>
                {% endif %}
              {% endwith %}
            </td>
            <td>
              {% if task.is_completed %}
                <span class="tag is-success">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
              {% else %}
                <span class="tag is-warning">–í —Ä–∞–±–æ—Ç–µ</span>
              {% endif %}
            </td>
            <td>
              {% if not task.is_completed and user == task.responsible %}
                <form method="post" action="{% url 'complete_task' task.pk %}">
                  {% csrf_token %}
                  <button class="button is-small is-success" type="submit">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      {% else %}
        <div class="notification is-info">
          –ù–µ—Ç –∑–∞–¥–∞—á –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        </div>
      {% endif %}
    </div>
  {% endfor %}

  <script>
    function showTab(role) {
      document.querySelectorAll('.task-tab').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.tabs li').forEach(el => el.classList.remove('is-active'));
      document.getElementById('tab-' + role).style.display = '';
      event.currentTarget.classList.add('is-active');

      // –û–±–Ω–æ–≤–ª—è–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º tab
      const url = new URL(window.location);
      url.searchParams.set('tab', role);
      window.history.replaceState({}, '', url);
    }

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω—É–∂–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const tab = urlParams.get('tab');
      if (tab) {
        showTab(tab);
      }
    });
  </script>
{% endblock %}