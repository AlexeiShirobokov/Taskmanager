{% extends 'base.html' %}
{% block title %}{% if is_edit %}Редактирование{% else %}Новая задача{% endif %}{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="text-center fw-semibold mb-4">{% if is_edit %}Редактировать задачу{% else %}Новая задача{% endif %}</h2>

  <div class="card clean">
    <div class="card-body">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="mb-3">
          <label class="form-label">Тема *</label>
          <input type="text" name="title" class="form-control" required
                 value="{{ form.instance.title|default_if_none:'' }}">
        </div>

        <div class="mb-3">
          <label class="form-label">Описание задачи *</label>
          <textarea name="description" class="form-control" rows="5" required>{{ form.instance.description }}</textarea>
        </div>

        <div class="row g-3">
          <div class="col-lg-6">
            <label class="form-label">Срок выполнения *</label>
            <input type="datetime-local" name="deadline" class="form-control" required
                   value="{% if form.instance.deadline %}{{ form.instance.deadline|date:'Y-m-d\\TH:i' }}{% endif %}">
          </div>
          <div class="col-lg-6">
            <label class="form-label">Ответственный *</label>
            <select name="responsible" class="form-select" required>
              <option value="" disabled {% if not form.instance.responsible %}selected{% endif %}>Выберите из списка</option>
              {% for u in users %}
                <option value="{{ u.id }}" {% if form.instance.responsible and u.id == form.instance.responsible.id %}selected{% endif %}>
                  {{ u.get_full_name|default:u.username }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="mt-4">
          <div class="fw-semibold mb-2">Дополнительные участники</div>
          <div id="participants-list" class="vstack gap-2">
            {% if is_edit and current_participants %}
              {% for p in current_participants %}
                <div class="border rounded p-3">
                  <div class="row g-2">
                    <div class="col-lg-7">
                      <select name="participants" class="form-select">
                        <option value="" disabled>Выберите пользователя</option>
                        {% for u in users %}
                          <option value="{{ u.id }}" {% if u.id == p.user.id %}selected{% endif %}>
                            {{ u.get_full_name|default:u.username }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-lg-3">
                      <select name="roles" class="form-select">
                        <option value="executor" {% if p.role == 'executor' %}selected{% endif %}>Исполнитель</option>
                        <option value="responsible" {% if p.role == 'responsible' %}selected{% endif %}>Ответственный</option>
                        <option value="observer" {% if p.role == 'observer' %}selected{% endif %}>Наблюдатель</option>
                      </select>
                    </div>
                    <div class="col-lg-2 d-grid">
                      <button type="button" class="btn btn-outline-danger remove-participant"><i class="bi bi-trash"></i> Удалить</button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% endif %}
          </div>

          <button type="button" id="add-participant" class="btn btn-outline-primary mt-2">
            <i class="bi bi-plus-circle"></i> Добавить участника
          </button>
        </div>

        <div class="mt-4">
          <div class="fw-semibold mb-2">Файлы</div>
          <div class="input-group">
            <input class="form-control" type="file" name="files" multiple>
            <button class="btn btn-primary" type="submit">Загрузить вместе с задачей</button>
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
          <a href="{% url 'task_list' %}" class="btn btn-secondary">Отмена</a>
          <button type="submit" class="btn btn-primary">{% if is_edit %}Сохранить{% else %}Создать задачу{% endif %}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<template id="participant-template">
  <div class="border rounded p-3">
    <div class="row g-2">
      <div class="col-lg-7">
        <select name="participants" class="form-select">
          <option value="" disabled selected>Выберите пользователя</option>
          {% for u in users %}
            <option value="{{ u.id }}">{{ u.get_full_name|default:u.username }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-lg-3">
        <select name="roles" class="form-select">
          <option value="executor" selected>Исполнитель</option>
          <option value="responsible">Ответственный</option>
          <option value="observer">Наблюдатель</option>
        </select>
      </div>
      <div class="col-lg-2 d-grid">
        <button type="button" class="btn btn-outline-danger remove-participant"><i class="bi bi-trash"></i> Удалить</button>
      </div>
    </div>
  </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const list = document.getElementById('participants-list');
  const btn  = document.getElementById('add-participant');
  const tpl  = document.getElementById('participant-template');

  btn?.addEventListener('click', () => {
    const node = tpl.content.cloneNode(true);
    list.appendChild(node);
  });

  list?.addEventListener('click', (e) => {
    if (e.target.closest('.remove-participant')) {
      e.target.closest('.border.rounded').remove();
    }
  });
});
</script>
{% endblock %}
